<div class="container mx-auto px-4 py-8">
  <!-- Comprehensive Debug Information (Development Only) -->
  <% if Rails.env.development? %>
    <div class="bg-yellow-100 p-4 mb-6 rounded-lg">
      <h3 class="font-bold mb-2">Detailed Debug Information</h3>
      <div class="text-xs overflow-x-auto space-y-2">
        <div>
          <strong>Raw Report Data:</strong>
          <pre class="bg-white p-2 rounded"><%= @report.data if @report %></pre>
        </div>
        <div>
          <strong>Report Data Present:</strong> <%= @report_data.present? %>
          <strong>Report Data Class:</strong> <%= @report_data.class %>
        </div>
        <div>
          <strong>Report Data Keys:</strong>
          <pre><%= @report_data.try(:keys) %></pre>
        </div>
        <div>
          <strong>Metadata Present:</strong> <%= @metadata.present? %>
          <strong>Metadata Class:</strong> <%= @metadata.class %>
        </div>
        <div>
          <strong>Metadata Keys:</strong>
          <pre><%= @metadata.try(:keys) %></pre>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Header -->
  <div class="mb-6 flex justify-between items-center">
    <h1 class="text-3xl font-bold">Tech Insights Report</h1>
    <%= link_to 'Generate New Report', new_report_path,
        class: "bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300" %>
  </div>

  <!-- Flash Messages -->
  <div class="mb-6">
    <% flash.each do |type, message| %>
      <div class="<%= type == 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700' %> p-4 rounded-lg mb-4">
        <%= message %>
      </div>
    <% end %>
  </div>

  <!-- Comprehensive Error Handling -->
  <% if @report_data.nil? || (!@report_data.is_a?(Hash) && !@report_data.is_a?(ActiveSupport::HashWithIndifferentAccess)) %>
    <div class="bg-red-100 p-6 rounded-lg text-center">
      <h2 class="text-2xl font-bold text-red-700 mb-4">Report Data Error</h2>
      <p class="text-red-600 mb-4">
        The report could not be displayed due to an unexpected data format.
        Please <%= link_to 'generate a new report', new_report_path, class: 'text-red-800 underline' %>.
      </p>

      <% if Rails.env.development? %>
        <div class="mt-4 bg-white p-4 rounded-lg text-left">
          <h3 class="font-bold mb-2">Technical Details:</h3>
          <pre class="text-xs overflow-x-auto">
            <%= debug({
              report_data_class: @report_data&.class,
              report_data_inspect: @report_data.inspect,
              report_attributes: @report&.attributes
            }) %>
          </pre>
        </div>
      <% end %>
    </div>
  <% else %>
    <!-- Report Overview -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">Report Overview</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div>
          <p class="text-gray-600">Date Range</p>
          <p class="font-medium"><%= @metadata[:date_range] || 'N/A' %></p>
        </div>
        <div>
          <p class="text-gray-600">Articles Analyzed</p>
          <p class="font-medium"><%= @metadata[:article_count] || 'N/A' %></p>
        </div>
        <div>
          <p class="text-gray-600">Report Type</p>
          <p class="font-medium"><%= @report.report_type&.titleize || 'N/A' %></p>
        </div>
        <div>
          <p class="text-gray-600">Detail Level</p>
          <p class="font-medium"><%= @report.detail_level&.titleize || 'N/A' %></p>
        </div>
      </div>
    </div>

    <!-- Executive Summary -->
    <% if @report_data[:executive_summary].present? %>
      <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Executive Summary</h2>
        <div class="text-gray-700 whitespace-pre-line">
          <%= @report_data[:executive_summary] %>
        </div>
      </div>
    <% end %>

    <!-- Key Trends -->
    <% if @report_data[:key_trends].present? %>
      <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Key Trends</h2>
        <div class="space-y-4">
          <% @report_data[:key_trends].each do |trend| %>
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-xl font-semibold mb-2"><%= trend[:title] %></h3>
              <p class="text-gray-700 mb-3"><%= trend[:description] %></p>

              <% if trend[:data].present? %>
                <div class="grid grid-cols-2 gap-2">
                  <% trend[:data].each do |key, value| %>
                    <div class="bg-white p-3 rounded shadow-sm">
                      <p class="font-medium"><%= key.to_s %></p>
                      <p class="text-gray-600"><%= value %></p>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Recommendations -->
    <% if @report_data[:recommendations].present? %>
      <div class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-4">Recommendations</h2>
        <div class="space-y-4">
          <% @report_data[:recommendations].each do |recommendation| %>
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-xl font-semibold mb-2"><%= recommendation[:title] %></h3>
              <div class="grid grid-cols-2 gap-4 mb-3">
                <div>
                  <span class="text-gray-600">Impact Level:</span>
                  <span class="ml-2 font-medium"><%= recommendation[:impact_level] %></span>
                </div>
                <div>
                  <span class="text-gray-600">Timeline:</span>
                  <span class="ml-2 font-medium"><%= recommendation[:timeline] %></span>
                </div>
              </div>
              <p class="text-gray-700"><%= recommendation[:description] %></p>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<script>
  // Client-side error catching
  window.addEventListener('error', function(event) {
    console.error('Unhandled error:', event.error);
    alert('An unexpected error occurred. Please try again or contact support.');
  });

  // Optional: Add print functionality
  function printReport() {
    window.print();
  }
</script>

<style>
  @media print {
    body * {
      visibility: hidden;
    }
    .container {
      visibility: visible;
      position: absolute;
      left: 0;
      top: 0;
    }
  }
</style>
